- hosts: ssr
  name: Run the SSR service based on the blubbler production variant
  tasks:
    - name: Ensure git is installed
      package:
          name: git
          state: present

    - name: Ensure docker is installed
      package:
          name: docker-ce
          state: present

    - name: Ensure blubber is installed
      package:
          name: blubber
          state: present

    - name: Ensure curl is installed
      package:
        name: curl
        state: present

    - name: Ensure project directory exists
      file:
          path: "{{ PATH }}"
          state: directory

    - name: Ensure project directory contains checkout
      git:
        repo: https://gerrit.wikimedia.org/r/wikibase/termbox
        dest: "{{ PATH }}/git"
        update: no
        version: "{{ BRANCH }}"

    - name: Ensure updater is in place
      template:
          src: templates/updater.sh.j2
          dest: "{{ PATH }}/updater.sh"
          owner: "root"
          group: "root"
          mode: 0744

    - name: Ensure updater is configured in crontab
      cron:
          name: Termbox updater
          job: "{{ PATH }}/updater.sh"
          minute: "*/{{ UPDATE_DURATION }}"
          user: root
          state: present

    - name: Ensure service is configured
      template:
        src: templates/termbox.service.j2
        dest: "/lib/systemd/system/termbox.service"
        owner: "root"
        group: "root"
        mode: 0644

    - name: Ensure systemd is using latest config
      systemd:
        daemon_reload: yes

    - name: Ensure the termbox service is running with the latest config
      systemd:
        state: restarted
        name: termbox
